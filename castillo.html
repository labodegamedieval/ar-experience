<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🏰 Castillo de Gonzalo</title>
  <link rel="stylesheet" href="styles/style.css" />
  <link rel="icon" type="image/jpeg" href="images/escudo-borrado.jpg" />
</head>
<body>
  <div class="container">
    <header>
      <h1>🏰 Castillo de Gonzalo</h1>
      <div class="music-control">
        <button class="music-btn"><span class="music-icon">🎵</span> Pausar Música</button>
      </div>
    </header>

    <section id="content">
      <div class="stop-icon">🏰</div>

      <div id="location-check">
        <h2>Verifica tu ubicación</h2>
        <p>Acércate a la torre del castillo para comenzar tu búsqueda.</p>
        <button class="action-btn" onclick="checkLocation()">Verificar GPS</button>
        <p>O escribe el nombre de la parada:</p>
        <input type="text" id="location-input" placeholder="Ej: castillo" />
        <button class="action-btn" onclick="checkLocationManual()">Verificar Manual</button>
        <p id="location-status"></p>
        <img id="direction-arrow" src="images/flecha.png" class="arrow-icon" style="display: none;">
      </div>

      <div id="game-content" style="display: none;">
        <!-- contenido original intacto -->

        <div id="continue-button" style="display: none; margin-top: 20px;">
          <p class="fragmento-final"><strong>Fragmento del mensaje:</strong> “Oculto...”</p>
          <button class="action-btn" onclick="guardarYContinuar()">Continuar aventura</button>
        </div>

        <div class="info">
          <p><strong>QR en el pueblo:</strong> CASTILLO-1834 (cerca de la torre)</p>
          <p><strong>Dato curioso:</strong> El castillo sirvió también como prisión eclesiástica durante el siglo XVIII.</p>
        </div>

        <h3>🏅 Clasificación - Castillo</h3>
        <p>Total de participantes: <span id="total-castillo">0</span></p>
        <table class="ranking-table" id="ranking-castillo">
          <thead>
            <tr><th>#</th><th>Nombre</th><th>Tiempo (s)</th><th>Aciertos</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <audio id="success-sound" src="sounds/success.mp3" preload="auto"></audio>
    <audio id="error-sound" src="sounds/error.mp3" preload="auto"></audio>
    <audio id="coins-sound" src="sounds/coins.mp3" preload="auto"></audio>
    <audio id="cheers-sound" src="sounds/cheers.mp3" preload="auto"></audio>
    <audio id="background-music" src="sounds/musica-medieval.mp3" preload="auto" loop></audio>

    <footer>
      <p>© 2025 La Bodega Medieval | <a href="https://www.labodegamedieval.es" target="_blank">Reserva tu visita</a></p>
    </footer>

    <script src="scripts/script.js"></script>
    <script>
      let aciertosCastillo = 0;
      let respuestasCastillo = {};
      const stop = "castillo";

      function checkVisualAnswer(respuesta, correcta, num) {
        const resultado = document.getElementById(`visual-resultado-${num}`);
        if (!respuestasCastillo[`visual-${num}`]) {
          respuestasCastillo[`visual-${num}`] = true;
          if (respuesta === correcta) aciertosCastillo++;
        }
        resultado.textContent = (respuesta === correcta) ? "✅ ¡Correcto!" : "❌ Incorrecto.";
        resultado.style.color = (respuesta === correcta) ? "green" : "darkred";
        playSound((respuesta === correcta) ? "coins-sound" : "error-sound");
      }

      function checkAnswer(respuesta, correcta, num) {
        const resultado = document.getElementById(`quiz-resultado-${num}`);
        if (!respuestasCastillo[`quiz-${num}`]) {
          respuestasCastillo[`quiz-${num}`] = true;
          if (respuesta === correcta) aciertosCastillo++;
        }
        resultado.textContent = (respuesta === correcta) ? "✅ ¡Correcto!" : "❌ Incorrecto.";
        resultado.style.color = (respuesta === correcta) ? "green" : "darkred";
        playSound((respuesta === correcta) ? "cheers-sound" : "error-sound");

        const total = document.querySelectorAll('[id^="quiz-resultado-"]').length + document.querySelectorAll('[id^="visual-resultado-"]').length;
        const contestadas = Object.keys(respuestasCastillo).length;
        if (contestadas >= total) {
          document.getElementById("continue-button").style.display = "block";
        }
      }

      function guardarYContinuar() {
        const nombre = localStorage.getItem("jugador") || "Anónimo";
        const inicio = Number(localStorage.getItem("inicio"));
        const tiempo = Math.round((Date.now() - inicio) / 1000);

        const entrada = { nombre, tiempo, aciertos: aciertosCastillo };

        // Clasificación global
        let ranking = JSON.parse(localStorage.getItem("ranking") || "[]");
        ranking.push(entrada);
        localStorage.setItem("ranking", JSON.stringify(ranking));

        // Clasificación por parada
        let rankingStop = JSON.parse(localStorage.getItem("ranking-" + stop) || "[]");
        rankingStop.push(entrada);
        localStorage.setItem("ranking-" + stop, JSON.stringify(rankingStop));

        window.location.href = `felicitaciones.html?stop=${stop}`;
      }

      function actualizarRankingCastillo() {
        const tabla = document.querySelector("#ranking-castillo tbody");
        const totalSpan = document.getElementById("total-castillo");
        let datos = JSON.parse(localStorage.getItem("ranking-castillo") || "[]");
        datos.sort((a,b) => a.tiempo - b.tiempo || b.aciertos - a.aciertos);
        totalSpan.textContent = datos.length;
        tabla.innerHTML = "";
        datos.slice(0,10).forEach((jugador, index) => {
          const fila = `<tr><td>${index + 1}</td><td>${jugador.nombre}</td><td>${jugador.tiempo}</td><td>${jugador.aciertos}</td></tr>`;
          tabla.innerHTML += fila;
        });
      }

      document.addEventListener("DOMContentLoaded", actualizarRankingCastillo);
    </script>
  </div>
</body>
</html>
